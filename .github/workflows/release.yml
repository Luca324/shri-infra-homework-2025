name: Release
on: [workflow_dispatch]

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                node-version: '20.x'
                cache: 'npm'
            - name: Install deps
              run: npm ci
            - name: Lint
              run: npm run lint
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                node-version: '20.x'
                cache: 'npm'
            - name: Install deps
              run: npm ci
            - name: Test
              run: npm run test
    create-branch:
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0  # Получить всю историю (нужно для создания веток)

        - name: Create and push branch
          run: |
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            git branch releases/${{ github.run_number }}
            git push origin releases/${{ github.run_number }}
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Авторизация
    build-and-push:
      needs: create-branch
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        
        - name: Login to Yandex Container Registry
          env:
            YC_TOKEN: ${{ secrets.OAUTH_TOKEN }}
          run: |
            docker login \
              --username oauth \
              --password $YC_TOKEN \
              cr.yandex

        - name: Build and tag Docker image
          run: |
            docker build . \
              -f Dockerfile \
              -t cr.yandex/${{ secrets.REGISTRY_ID }}/app:${{ github.run_number }} \
              -t cr.yandex/${{ secrets.REGISTRY_ID }}/app:${{ github.run_number }}_latest

        - name: Push Docker images
          run: |
            docker push cr.yandex/${{ secrets.REGISTRY_ID }}/app:${{ github.run_number }}
            docker push cr.yandex/${{ secrets.REGISTRY_ID }}/app:${{ github.run_number }}_latest